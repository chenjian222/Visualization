  <!--
 * @Description: 
 * @Author: peng.zhang
 * @Date: 2023-04-05 01:31:15
 * @LastEditors: peng.zhang
 * @LastEditTime: 2023-05-24 19:27:30
-->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>.加载FBX并解析骨骼动画</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/three.js/0.151.2/three.min.js"></script>
    <script src="./assets/script/jquery.min.js"></script>
    <script src="https://res.weiunity.com/msg/msg.js"></script>
    <!-- <script src="./assets/script/three.js"></script> -->
    <script src="./assets/script/OrbitControls.js"></script>
    <script src="./assets/script/FBXLoader.js"></script>
    <script src="./assets/script/fflate.js"></script>
  </head>

  <body>
    <div>
      sad
    </div>
    <script>
      const mapper = [
        'm_avg_Pelvis',
        'm_avg_L_Hip',
        'm_avg_R_Hip',
        'm_avg_Spine3',
        'm_avg_L_Knee',
        'm_avg_R_Knee',
        'm_avg_Spine2',
        'm_avg_L_Ankle',
        'm_avg_R_Ankle',
        'm_avg_Spine1',
        'm_avg_L_Foot',
        'm_avg_R_Foot',
        'm_avg_Neck',
        'm_avg_L_Collar',
        'm_avg_R_Collar',
        'm_avg_Head',
        'm_avg_L_Shoulder',
        'm_avg_R_Shoulder',
        'm_avg_L_Elbow',
        'm_avg_R_Elbow',
        'm_avg_L_Wrist',
        'm_avg_R_Wrist',
        'm_avg_L_Hand',
        'm_avg_R_Hand',
      ]
      // const mapper = ['m_avg_Spine2', 'm_avg_Spine1', 'm_avg_Spine3', 'm_avg_Pelvis', 'm_avg_Neck', 'm_avg_L_Collar', 'm_avg_R_Collar', 'm_avg_L_Hip', 'm_avg_R_Hip', 'm_avg_Head', 'm_avg_L_Shoulder', 'm_avg_R_Shoulder', 'm_avg_L_Knee', 'm_avg_R_Knee', 'm_avg_L_Elbow', 'm_avg_R_Elbow', 'm_avg_L_Ankle', 'm_avg_R_Ankle', 'm_avg_L_Wrist', 'm_avg_R_Wrist', 'm_avg_L_Foot', 'm_avg_R_Foot', 'm_avg_L_Hand', 'm_avg_R_Hand']
      // 1，创建场景
      var scene = new THREE.Scene()
      var quaternions = []
      // 创建STL加载器
      var fbxLoader = new THREE.FBXLoader()

      // $.getJSON('./assets/data/data.json', data => {
    $.getJSON('./assets/data/quaternion.json', data => {
      // data
      // 去除开头的 "[" 和末尾的 "]" 目前为每个数组项为 x y z 需要解析
      arr = data.data.slice(1, -1).split("][");
      arr = arr.map(item => {
        let aux = []
        // item.trim().split(/\s+/).forEach(str => {
        item.trim().split(',').forEach(str => {
          aux.push(parseFloat(str))
        })
        return aux
      })
      console.log(arr)
      let len = Math.round(arr.length / 24);
      
      console.log(len)
      for (let i = 0;i < len;i++) {
        let temp = [];
        for (let j = 0;j < 24;j++) {
          temp.push(arr[i * 24 + j]);
        }
        //console.log(temp)
        quaternions.push(temp);
      }
      // 24骨骼
      
    })

      fbxLoader.load(
        './assets/model/smallBody.fbx',
        // fbxLoader.load('./assets/model/bed.fbx',
        (obj) => {
          console.log(obj)
          scene.add(obj)
          let rl = obj.children[0]
          let { skeleton } = rl
          let { bones } = skeleton
          let nodes = mapper
            .map((item) => {
              return bones.filter((bone) => {
                return item === bone.name
              })
            })
            .flat()

          
          let times = 0
          function render() {
            if (times > quaternions.length) return
            let quaternion = quaternions[times++]
             for (let i = 0; i < nodes.length; i++) {
            //   z y x
              let w = quaternion[i][0],
                 x = quaternion[i][1],
                 y = quaternion[i][2],
                 z = quaternion[i][3]
               nodes[i].quaternion.w = w
               nodes[i].quaternion.x = x
               nodes[i].quaternion.y = y
               nodes[i].quaternion.z = z
             }
            renderer.render(scene, camera)
            setTimeout(() => {
            // Continue the animation loop
            requestAnimationFrame(render);
          }, 30);
           
          }
          render()
        }
      )
      // 3,创建灯光
      var point = new THREE.PointLight(0xffffff, 0.5)
      point.position.set(1400, 1400, 1400)
      scene.add(point)
      var point2 = new THREE.PointLight(0xffffff, 0.5)
      point2.position.set(-1400, 1400, 1400)
      scene.add(point2)
      var point3 = new THREE.PointLight(0xffffff)
      point3.position.set(1400, -1400, -1400)

      // 4,创建相机对象
      var width = window.innerWidth
      var height = window.innerHeight
      var k = width / height
      var s = 500
      var camera = new THREE.OrthographicCamera(
        -s * k,
        s * k,
        s,
        -s,
        -2000,
        2000
      )
      camera.position.set(300, 200, 100)
      camera.lookAt(scene.position)
      // 5，创建渲染器
      var renderer = new THREE.WebGLRenderer()
      renderer.setSize(width, height)
      document.body.appendChild(renderer.domElement)

      function render() {
        renderer.setClearColor(0xcce0ff, 1)
        renderer.render(scene, camera)
        requestAnimationFrame(render)
      }
      var controls = new THREE.OrbitControls(camera, renderer.domElement)
      var axes = new THREE.AxesHelper(500)
      scene.add(axes)
      render()
    </script>
  </body>
</html>
