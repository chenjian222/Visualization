<!--
 * @Description: 
 * @Author: peng.zhang
 * @Date: 2023-04-05 01:31:15
 * @LastEditors: peng.zhang
 * @LastEditTime: 2023-05-12 11:28:43
-->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>可视化部分</title>
    <script src="./assets//script/three.min.js"></script>
    <script src="./assets/script/jquery.min.js"></script>
    <script src="https://res.weiunity.com/msg/msg.js"></script>
    <!-- <script src="./assets/script/three.js"></script> -->
    <script src="./assets/script/OrbitControls.js"></script>
    <script src="./assets/script/FBXLoader.js"></script>
    <script src="./assets/script/fflate.js"></script>
  </head>

  <body>
    <script>
      let N = 128
      let analyser = null
      var quaternions = []
      const mapper = [
        'm_avg_Pelvis',
        'm_avg_L_Hip',
        'm_avg_R_Hip',
        'm_avg_Spine3',
        'm_avg_L_Knee',
        'm_avg_R_Knee',
        'm_avg_Spine2',
        'm_avg_L_Ankle',
        'm_avg_R_Ankle',
        'm_avg_Spine1',
        'm_avg_L_Foot',
        'm_avg_R_Foot',
        'm_avg_Neck',
        'm_avg_L_Collar',
        'm_avg_R_Collar',
        'm_avg_Head',
        'm_avg_L_Shoulder',
        'm_avg_R_Shoulder',
        'm_avg_L_Elbow',
        'm_avg_R_Elbow',
        'm_avg_L_Wrist',
        'm_avg_R_Wrist',
        'm_avg_L_Hand',
        'm_avg_R_Hand',
      ]
      // const mapper = ['m_avg_Spine2', 'm_avg_Spine1', 'm_avg_Spine3', 'm_avg_Pelvis', 'm_avg_Neck', 'm_avg_L_Collar', 'm_avg_R_Collar', 'm_avg_L_Hip', 'm_avg_R_Hip', 'm_avg_Head', 'm_avg_L_Shoulder', 'm_avg_R_Shoulder', 'm_avg_L_Knee', 'm_avg_R_Knee', 'm_avg_L_Elbow', 'm_avg_R_Elbow', 'm_avg_L_Ankle', 'm_avg_R_Ankle', 'm_avg_L_Wrist', 'm_avg_R_Wrist', 'm_avg_L_Foot', 'm_avg_R_Foot', 'm_avg_L_Hand', 'm_avg_R_Hand']
      // 1，创建场景
      var scene = new THREE.Scene()
      var ws = null;

      var i = 1
      // 创建STL加载器
      var fbxLoader = new THREE.FBXLoader()
      
      fbxLoader.load(
        './assets/model/bodyFinal.fbx',
        // fbxLoader.load('./assets/model/bed.fbx',
        (obj) => {
          scene.add(obj)
          let rl = obj.children[0]
          let { skeleton } = rl
          let { bones } = skeleton
          let nodes = mapper
            .map((item) => {
              return bones.filter((bone) => {
                return item === bone.name
              })
            })
            .flat()
          var ws = new WebSocket('')
          
          ws.onopen = function () {
              console.log("建立连接")
          }
          
          
          ws.onmessage = function (evt) {
            var received_msg = evt.data
            
            let arr = received_msg.slice(8, -2)
            var regex =/\[(.*?)\]/g; // 匹配以 [ 开始，以 ] 结束的内容

            var matches = arr.match(regex); // 获取所有匹配到的字符串

            var result = matches.map(function(match) {
              return match.substring(1, match.length - 1); // 去除首尾的 [ ]
            });
            // 可以看到处理掉tensor[]后的数据
            console.log(result, new Date(), i)
            i = i + 1
            let quaternion = result.map((item) => {
              let aux = []
              item.split(',').forEach((str) => {
                aux.push(parseFloat(str))
              })
              // console所有的四元数，可以看到每个四元数
              //console.log(aux)
              return aux
            })
            for (let i = 0;i < nodes.length;i++) {
              let w = quaternion[i][0], x = quaternion[i][1], y = quaternion[i][2], z = quaternion[i][3];
              nodes[i].quaternion.w = w
              nodes[i].quaternion.x = x
              nodes[i].quaternion.y = y
              nodes[i].quaternion.z = z
            }
            renderer.render(scene, camera)
            ws.send("H");
          }

          ws.onclose = function () {
            // 关闭 websocket
            msg.info('连接已关闭...');
          }
          
          let times = 0
          function render() {
            if (times > quaternions.length) return
            let quaternion = quaternions[times++]
            for (let i = 0; i < nodes.length; i++) {
              // z y x
              let w = quaternion[i][0],
                x = quaternion[i][1],
                y = quaternion[i][2],
                z = quaternion[i][3]
              nodes[i].quaternion.w = w
              nodes[i].quaternion.x = x
              nodes[i].quaternion.y = y
              nodes[i].quaternion.z = z
            }
            renderer.render(scene, camera)
            requestAnimationFrame(render)
          }
        }
      )
      // 3,创建灯光
      var point = new THREE.PointLight(0xffffff, 0.5)
      point.position.set(200, 200, -200)
      scene.add(point)
      var point2 = new THREE.PointLight(0xffffff, 0.5)
      point2.position.set(-200, 200, -200)
      scene.add(point2)
      var point3 = new THREE.PointLight(0xffffff)
      point3.position.set(200, -200, -200)

      // 4,创建相机对象
      var width = window.innerWidth
      var height = window.innerHeight
      var k = width / height
      var s = 50
      var camera = new THREE.OrthographicCamera(
        -s * k,
        s * k,
        s,
        -s,
        -2000,
        2000
      )
      camera.position.set(100, 700, -100)
      camera.lookAt(scene.position)
      // 5，创建渲染器
      var renderer = new THREE.WebGLRenderer()
      renderer.setSize(width, height)
      document.body.appendChild(renderer.domElement)

      function render() {
        renderer.setClearColor(0xcce0ff, 1)
        renderer.render(scene, camera)
        requestAnimationFrame(render)
      }
      var controls = new THREE.OrbitControls(camera, renderer.domElement)
      var axes = new THREE.AxesHelper(500)
      scene.add(axes)
      render()
    </script>
  </body>
</html>
